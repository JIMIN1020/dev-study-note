## ğŸ“Â DB ëª¨ë“ˆí™”

ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ dbë¥¼ ë¶ˆëŸ¬ì™€ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `module.exports` ë¡œ db connectionì„ exportí•œë‹¤.

```tsx
const mysql = require("mysql2");

// db ì—°ê²°í•˜ê¸°
const connection = mysql.createConnection({
  host: "localhost",
  user: "root",
  password: "root",
  database: "Youtube",
  dateStrings: true, // dateë¥¼ stringìœ¼ë¡œ ë°›ì•„ì˜¤ê¸°
});

// export
module.exports = connection;
```

ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ dbë¥¼ ë¶ˆëŸ¬ì˜¬ ë• ë‹¤ìŒê³¼ ê°™ì´!

```tsx
const conn = require("../db");
```

<br/>

## ğŸ“Â Prepare Statement

Node.jsì—ì„œ ì¿¼ë¦¬ ì‘ì„± ì‹œ íŒŒë¼ë¯¸í„° ê°’ì„ í¬í•¨í•´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” â€˜Prepare statementâ€™ë¼ ë¶ˆë¦¬ëŠ” ë¬¼ìŒí‘œ(?)ë¥¼ ì¿¼ë¦¬ì— ì‘ì„±í•œ ë’¤, ì¿¼ë¦¬ì˜ ë‘ë²ˆì§¸ ì¸ìë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì „ë‹¬í•˜ë©´ ëœë‹¤.

```tsx
conn.query(
	`SELECT * FROM users WHERE email = ?`,
	email,
	...
);
```

ë§Œì•½ íŒŒë¼ë¯¸í„°ê°€ 2ê°œ ì´ìƒì´ë¼ë©´ ë°°ì—´ë¡œ ê°ì‹¸ì¤„ ìˆ˜ ìˆë‹¤.

```tsx
conn.query(
	`SELECT * FROM users WHERE email = ? AND name = ?`,
	[email, name],
	...
);
```

ë‹¤ë¥¸ ì¿¼ë¦¬ë„ SELECTì™€ ê°™ì´ ë¬¼ìŒí‘œë¥¼ ì‚¬ìš©í•˜ë©´ íŒŒë¼ë¯¸í„°ë¥¼ ë§¤í•‘í•  ìˆ˜ ìˆë‹¤.

```tsx
conn.query(
	`INSERT INTO users (email, name, pw) VALUES (?, ?, ?)`,
	[email, name, pw],
	...
);
```

<br/>

## ğŸ“Â ë¯¸ë‹ˆ í”„ë¡œì íŠ¸: users ì—°ë™

### âœ”ï¸Â íšŒì› ê°œë³„ ì¡°íšŒ API

```tsx
/* ----- íšŒì› ê°œë³„ ì¡°íšŒ API ----- */
router.route("/users").get((req, res) => {
  const { email } = req.body;
  const sql = `SELECT * FROM users WHERE email = ?`;

  // sql ì¿¼ë¦¬ ì‘ì„±
  conn.query(sql, email, (_, results) => {
    // ê²°ê³¼ê°’ì´ ìˆë‹¤ë©´ ë°˜í™˜, ì—†ë‹¤ë©´ 404
    if (results.length > 0) {
      res.status(200).json({
        isSuccess: true,
        result: results,
      });
    } else {
      res.status(404).json({
        isSuccess: false,
        message: `íšŒì› ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`,
      });
    }
  });
});
```

<br/>

### âœ”ï¸Â íšŒì›ê°€ì… API

```tsx
/* ----- íšŒì›ê°€ì… API ----- */
router.post("/join", (req, res) => {
  const { email, name, pw } = req.body; // ì‹ ê·œ ìœ ì € ì •ë³´

  const sql = `INSERT INTO users (email, name, pw) VALUES (?, ?, ?)`;
  const values = [email, name, pw];

  // íšŒì› ê°€ì…í•  ìœ ì € ì •ë³´ê°€ ìˆë‹¤ë©´? ë“±ë¡!
  if (Object.keys(req.body).length > 0) {
    // dbì— insert í•˜ê¸°
    conn.query(sql, values, (err) => {
      // ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš° 400
      if (err) {
        res.status(400).json({
          isSuccess: false,
          message: `ìš”ì²­ ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`,
        });
      } else {
        res.status(201).json({
          isSuccess: true,
          message: `${name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`,
        });
      }
    });
  }
});
```

<br/>

### âœ”ï¸Â íšŒì› íƒˆí‡´ API

```tsx
/* ----- íšŒì› íƒˆí‡´ API ----- */
  .delete((req, res) => {
    const { email } = req.body;
    const sql = `DELETE FROM users WHERE email = ?`;

    // sql ì¿¼ë¦¬ ì‘ì„±
    conn.query(sql, email, (err, results) => {
      // ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš° 400
      if (err) {
        res.status(400).json({
          isSuccess: false,
          message: `ìš”ì²­ ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`,
        });
      } else {
        res.status(201).json({
          isSuccess: true,
          results: results,
          message: `íšŒì› íƒˆí‡´ê°€ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        });
      }
    });
  });
```

DELETEë¥¼ í–ˆì„ ë•Œ ê²°ê³¼ ê°’ìœ¼ë¡œ ë°˜í™˜ë˜ëŠ” `results` ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê°’ë“¤ì´ ìˆë‹¤.

ë§Œì•½ ì‚­ì œê°€ ë˜ì§€ ì•Šì€ ê²½ìš° ì´ `affectedRows` ë¥¼ í™œìš©í•˜ê±°ë‚˜, 404ë¡œ ë”°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

```tsx
"results": {
	"fieldCount": 0,
	"affectedRows": 1,  // ì˜í–¥ì„ ë°›ì€ row
	"insertId": 0,
	"info": "",
	"serverStatus": 2,
	"warningStatus": 0,
	"changedRows": 0
},
```

<br/>

### âœ”ï¸Â ë¡œê·¸ì¸ API

```tsx
/* ----- ë¡œê·¸ì¸ API ----- */
router.post("/login", (req, res) => {
  const { email, pw } = req.body;
  const sql = `SELECT * FROM users WHERE email = ?`;

  // íšŒì› ì´ë©”ì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸°
  conn.query(sql, email, (_, results) => {
    let userData = {};
    userData = results[0];

    // ìœ ì €ê°€ ì¡´ì¬í•˜ë©´? ë¡œê·¸ì¸í•˜ê¸°
    if (userData) {
      // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
      if (userData.pw === pw) {
        res.status(200).json({
          isSuccess: true,
          message: `${userData.name}ë‹˜, ë¡œê·¸ì¸ ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        });
      } else {
        res.status(401).json({
          isSuccess: false,
          message: `ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`,
        });
      }
    }
    // ìœ ì €ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ë¦¬í„´
    else {
      res.status(404).json({
        isSuccess: false,
        message: `ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.`,
      });
    }
  });
});
```

<br/>

## ğŸ“Â ë¯¸ë‹ˆ í”„ë¡œì íŠ¸: channels ì—°ë™

### âœ”ï¸Â ì±„ë„ ê°œë³„ ì¡°íšŒ API

```tsx
/* ----- ì±„ë„ ê°œë³„ ì¡°íšŒ API ----- */
router.route("/:id").get((req, res) => {
  const id = +req.params.id;
  const sql = `SELECT * FROM channels WHERE id = ?`;

  conn.query(sql, id, (_, results) => {
    // ì±„ë„ ì •ë³´ê°€ ì¡´ì¬í•˜ë©´ ë°˜í™˜!
    if (results.length > 0) {
      res.status(200).json({
        isSuccess: true,
        result: results[0],
      });
    } else {
      channelNotFound(res);
    }
  });
});
```

<br/>

### âœ”ï¸Â ì±„ë„ ì „ì²´ ì¡°íšŒ API

```tsx
/* ----- ì±„ë„ ì „ì²´ ì¡°íšŒ API ----- */
router.route("/").get((req, res) => {
  const userId = req.body.userId; // id ë°›ì•„ì˜¤ê¸°

  if (userId) {
    const sql = `SELECT * FROM channels WHERE user_id = ?`;

    conn.query(sql, userId, (_, results) => {
      // ê²°ê³¼ ê°’ì´ ìˆìœ¼ë©´ ë°˜í™˜!
      if (results.length > 0) {
        res.status(200).json({ isSuccess: true, results: results });
      } else {
        channelNotFound(res);
      }
    });
  } else {
    // userIdê°€ bodyì— ì—†ëŠ” ê²½ìš° = ë¡œê·¸ì¸ ë§Œë£Œëœ ê²½ìš°, ì˜ëª»ëœ ì ‘ê·¼
    res.status(404).json({
      isSuccess: false,
      message: `ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
    });
  }
});
```

<br/>

### âœ”ï¸Â ì±„ë„ ìƒì„± API

```tsx
/* ----- ì±„ë„ ìƒì„± API ----- */
  .post((req, res) => {
    const { channelName, userId } = req.body;

    const sql = `INSERT INTO channels (channel_name, user_id) VALUES (?, ?);`;
    const values = [channelName, userId];

    if (userId && channelName) {
      conn.query(sql, values, (err) => {
        if (err) {
          res.status(400).json({
            isSuccess: false,
            message: `ì±„ë„ ìƒì„±ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`,
          });
        } else {
          res.status(201).json({
            isSuccess: true,
            message: `ì±„ë„ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`,
          });
        }
      });
    } else {
      // ìš”ì²­ ê°’ì´ ì—†ëŠ” ê²½ìš°
      res.status(400).json({
        isSuccess: false,
        message: `ìš”ì²­ ê°’ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`,
      });
    }
  });
```
